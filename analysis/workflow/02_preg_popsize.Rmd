---
title: "Density-dependent pregnancy rates"
author: "Max Czapanskiy"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = here::here())
library(lubridate)
library(tidyverse)
```

## Population sizes

Christensen et al. (2006) reconstructed population sizes of whale populations.

```{r read_pops}
whale_pops <- readxl::read_excel("analysis/data/raw_data/Whale_pops_time_Christensen 2006.xlsx") %>% 
  # Years have decimals for some reason
  mutate(Year = floor(Year),
         # Sperm Whale populations weren't broken down by hemisphere, so
         # we're just using the global population for now
         Region = ifelse(CommonName == "Sperm Whale",
                         "Southern Hemisphere",
                         Region))
glimpse(whale_pops)
```

```{r whale_pops_ts}
whale_pops %>% 
  filter(between(Year, 1900, 2000),
         CommonName %in% c("Blue Whale",
                           "Fin Whale",
                           "Sperm Whale"),
         Region == "Southern Hemisphere") %>% 
  mutate(Pop_size = Pop_size / 1000) %>% 
  ggplot(aes(Year, Pop_size, color = CommonName)) +
  geom_line() +
  scale_y_continuous("Population size (1000s)") +
  theme_classic() +
  theme(legend.position = "bottom",
        legend.title = element_blank())
```

## Density-dependent pregnancy rates

```{r iwc}
whale_catches <- readRDS("analysis/data/derived_data/great_whales_iwc.RDS") %>% 
  filter(species %in% c("Blue",
                        "Fin",
                        "Sperm")) %>% 
  mutate(species = paste(as.character(species), "Whale"))

whale_preg <- whale_catches %>% 
  filter(sex == "Female") %>% 
  drop_na(latitude) %>% 
  mutate(Hemisphere = ifelse(latitude < 0, "S", "N")) %>% 
  group_by(Year = catch_year,
           CommonName = species,
           Hemisphere) %>% 
  summarize(n_f_catch = n(),
            preg_rate = sum(is_pregnant) / n(),
            .groups = "drop") %>% 
  filter(n_f_catch >= 10)
```

```{r ddpr}
sh_whales <- whale_pops %>% 
  filter(between(Year, 1800, 2000),
         Region == "Southern Hemisphere",
         CommonName %in% c("Blue Whale", "Fin Whale", "Sperm Whale")) %>% 
  left_join(filter(whale_preg, Hemisphere == "S"), 
            by = c("Year", "CommonName"))

ggplot(sh_whales, aes(Pop_size / 1000, preg_rate)) + 
  geom_point() +
  geom_smooth(se = FALSE) +
  facet_grid(cols = vars(CommonName), scales = "free_x") +
  scale_y_continuous("Pregnancy Rate", labels = scales::percent) +
  scale_color_manual(values = c(`TRUE` = "red", `FALSE` = "blue")) +
  labs(x = "Population (1000s)") +
  expand_limits(x = 0, y = 0) +
  theme_classic()
```

Catches and populations over time
```{r catch_pop}
sh_catches <- whale_catches %>% 
  drop_na(latitude) %>% 
  filter(latitude < 0, species != "Antarctic Minke Whale") %>% 
  group_by(Year = catch_year,
           CommonName = species) %>% 
  summarize(Catches = n(), .groups = "drop")

ggplot() + 
  geom_line(aes(Year, Pop_size / 1000),
            filter(sh_whales, between(Year, 1920, 1990)),
            color = "blue",
            size = 1) +
  geom_line(aes(Year, Catches / 1000),
            filter(sh_catches, between(Year, 1920, 1990)),
            color = "red",
            size = 1) +
  facet_grid(cols = vars(CommonName), scales = "free_x") +
  labs(y = "Whales (1000s)") +
  theme_classic(base_size = 24)
```

```{r preg_model}
# Normalize population sizes wrt k, assuming max pop size is k
preg_wide <- sh_whales %>% 
  group_by(CommonName) %>% 
  mutate(pop_norm = Pop_size / max(Pop_size),
         n_preg = floor(n_f_catch * preg_rate)) %>% 
  ungroup() %>% 
  drop_na(n_preg) %>% 
  filter(between(Year, 1900, 1990))

# Fit the model for populations greater than k/5
preg_data <- filter(preg_wide, pop_norm >= 0.2)
preg_glm <- glm(preg_rate ~ pop_norm * CommonName, 
                data = preg_data, 
                family = binomial,
                weights = n_f_catch)

# Plot results
preg_grid <- expand_grid(
  CommonName = unique(preg_wide$CommonName),
  pop_norm = seq(0.2, 1, length.out = 100)
)
preg_pred <- predict(preg_glm, newdata = preg_grid, type = "link", se.fit = TRUE)
invlink_fun <- family(preg_glm)$linkinv
preg_grid$preg_rate <- invlink_fun(preg_pred$fit)
preg_grid$preg_rate_lwr <- invlink_fun(preg_pred$fit - 2 * preg_pred$se.fit)
preg_grid$preg_rate_upr <- invlink_fun(preg_pred$fit + 2 * preg_pred$se.fit)
# Constrain to interpolating pop sizes
pop_constraints <- preg_data %>% 
  group_by(CommonName) %>% 
  summarize(min_pop = min(pop_norm),
            max_pop = max(pop_norm),
            .groups = "drop")
preg_grid <- preg_grid %>% 
  left_join(pop_constraints, by = "CommonName") %>% 
  filter(pop_norm >= min_pop,
         pop_norm <= max_pop)

ggplot(preg_grid, aes(pop_norm, preg_rate, color = CommonName)) +
  geom_point(aes(size = n_f_catch), preg_wide, shape = 21) +
  geom_ribbon(aes(fill = CommonName, 
                  ymin = preg_rate_lwr, 
                  ymax = preg_rate_upr),
              alpha = 0.25,
              color = NA) +
  geom_line() +
  labs(x = "Population size (normalized)",
       y = "Pregnancy probability",
       color = "",
       fill = "",
       size = "Females caught (annual)") +
  theme_classic() +
  theme(legend.position = "bottom",
        legend.box = "vertical")
```

```{r preg_coef}
library(emmeans)
library(ggsignif)
preg_em <- emtrends(preg_glm, "CommonName", "pop_norm")
preg_pairs <- as_tibble(pairs(preg_em)) %>% 
  mutate(comparisons = str_split(contrast, " - "),
         annotations = sprintf("p = %.7f", signif(p.value, 2)),
         # remove trailing zeros
         annotations = str_remove(annotations, "0+$"))
plot(preg_em,
     xlab = "Coef") +
  geom_signif(
    comparisons = preg_pairs$comparisons,
    annotations = preg_pairs$annotations,
    step_increase = 0.1
  ) +
  expand_limits(x = 0) +
  theme_classic() +
  theme(axis.title.y = element_blank())
```

A modified Ricker model. $R$ is recruits, $S$ is stock size, $a$ and $b$ are parameters describing the number of recruits per spawner at low stock sizes and the strength of density dependence, respectively. We have $S$ (population size), we want to estimate $a$ and $b$.

$$
R = a S e^{-bS}
$$

But what's $R$? Let's consider "pregnancy" to mean "recruitment to the fetus age-class". Then $R$ is the product of pregnancy rate, $g$, and $S$.

$$
R = g S
$$

Then:

$$
R = a S e^{-bS}    \\
g S = a S e^{-bS}  \\
g = a e^{-bS}
$$

We estimate $g$ by saying the number of pregnant females caught, $n_g$, is a binomial random variable with trials equal to the number of females caught, $n_f$, and probability of pregnancy $g$.

$$
n_g \sim B(n_f, g)
$$
I feel good about this so far, I think. But how do I implement that non-linear model? Here's my attempt for fin whales only.

Estimate starting parameters by fitting the following linear model.

$$ 
g = ae^{-bS}   \\
ln(g) = -bS + ln(a)
$$

```{r modricker}
# Negative log likelihood function
modrickernll <- function(par, s, ng, nf) {
  a <- par[1]
  b <- par[2]
  if (a >= 0 && b >= 0) {
    g <- a * exp(-b * s)
    nll <- -sum(dbinom(ng, size = nf, prob = g, log = TRUE))
  } else {
    nll <- 1e6
  }
  nll
}

# Starting parameters
fin_data <- filter(preg_wide, CommonName == "Fin Whale")
ricker_start_lm <- lm(log(preg_rate) ~ Pop_size, 
                      filter(fin_data, preg_rate > 0),
                      weights = fin_data$n_f_catch)
a0 <- exp(coef(ricker_start_lm)["(Intercept)"])
b0 <- -coef(ricker_start_lm)["Pop_size"]

# Fit model
ricker_mle <- optim(
  par = c(a = a0, b = b0),
  fn = modrickernll,
  s = fin_data$Pop_size,
  ng = fin_data$n_preg,
  nf = fin_data$n_f_catch,
  hessian = TRUE
)
```

```{r}
ggplot(fin_data, aes(x = Pop_size, y = preg_rate)) +
  geom_point() +
  geom_function(fun = ~ a0 * exp(-b0 * .x))
```

